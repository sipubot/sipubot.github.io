var SipuViewer=function(n,t){function r(a,b,d){var h=new XMLHttpRequest;h.onreadystatechange=function(){h.readyState===XMLHttpRequest.DONE&&(200===h.status?b&&b(JSON.parse(h.responseText)):d&&d(h))};h.open("GET",a,!0);h.send()}function k(a,b){a=Math.ceil(a);b=Math.floor(b);return Math.floor(Math.random()*(b-a+1))+a}function p(a){return"#"+a.map(function(a){return 1==a.toString(16).length?"0"+a.toString(16):a.toString(16)}).join("")}function u(a){var b=a.clientX-f.bound.left;a=a.clientY-f.bound.top;
v(b,a);w(b,a)}function v(a,b){var h=-1;d.Pos.map(function(c,e){c[0]-d.PicHarfSize<a&&c[0]+d.PicHarfSize>a&&c[1]-d.PicSize<b&&c[1]>b&&(h=e)});-1!==h&&c.State===l.Walk&&(-1===h?c.Target=-1:c.Target!==h&&(c.State=l.Turn,c.Target=h,d.PathSet.x=a,d.PathSet.y=b,q(""),console.log(c.TimeSet,h)))}function w(a,h){Object.keys(b.POS).map(function(d){!1!==("APPLE"===d||"CARROT"===d||"STRAWBERRY"===d)&&b.POS[d].map(function(e,f){e[0]<a&&e[0]+e[2]>a&&e[1]<h&&e[1]+e[2]>h&&c.State===l.Walk&&(console.log(b.POS[d],
a,h),c.Energy=c.Energy+.1*b.LIFE[d][f]>c.EnergyMax?c.EnergyMax:c.Energy+.1*b.LIFE[d][f],b.LIFEADDPOS=[a-12,h-12,20,1],b.LIFE[d][f]=0)})})}function x(a){c.State===l.Rest&&(c.Energy>.5*c.EnergyMax?(c.PosYAdd[0]=0<c.PosYAdd[0]?c.PosYAdd[0]-a:0,c.PosYAdd[1]=0>c.PosYAdd[1]?c.PosYAdd[1]+a:0,c.PosYAdd[2]=0<c.PosYAdd[2]?c.PosYAdd[2]-a:0,c.PosYAdd.every(function(a){return 0===a})&&(c.State=l.Walk,console.log(c.Pos,"Go again"))):(c.PosYAdd[0]=c.PosYAdd[0]<c.RestPostYOri[0]?c.PosYAdd[0]+a:c.RestPostYOri[0],
c.PosYAdd[1]=c.PosYAdd[1]>c.RestPostYOri[1]?c.PosYAdd[1]-a:c.RestPostYOri[1],c.PosYAdd[2]=c.PosYAdd[2]>c.RestPostYOri[2]?c.PosYAdd[2]-a:c.RestPostYOri[2],c.Energy+=.5*a));c.State===l.Walk&&(0===c.Energy?c.State=l.Rest:(c.Energy-=.1*a,c.Energy=0>c.Energy?0:c.Energy,c.MovIdx=(c.MovIdx+1)%c.Mov.length))}function y(a){if(0<b.TARGET.BUTTERFLY.length){var d=k(2,4)*a*2,c=k(2,4)*a*2;b.POS.BUTTERFLY[0]=b.POS.BUTTERFLY[0]>b.TARGET.BUTTERFLY[0][0]?b.POS.BUTTERFLY[0]-d:b.POS.BUTTERFLY[0]+d;b.POS.BUTTERFLY[1]=
b.POS.BUTTERFLY[1]>b.TARGET.BUTTERFLY[0][1]?b.POS.BUTTERFLY[1]-c:b.POS.BUTTERFLY[1]+c;2>Math.abs(b.TARGET.BUTTERFLY[0][0]-b.POS.BUTTERFLY[0])&&2>Math.abs(b.TARGET.BUTTERFLY[0][1]-b.POS.BUTTERFLY[1])&&b.TARGET.BUTTERFLY.shift();b.TARGET.BUTTERFLYWING?(b.POS.BUTTERFLY[2]-=a*b.TARGET.BUTTERFLYSPEED,1>=b.POS.BUTTERFLY[2]&&(b.TARGET.BUTTERFLYWING=!1)):(b.POS.BUTTERFLY[2]+=a*b.TARGET.BUTTERFLYSPEED,20<=b.POS.BUTTERFLY[2]&&(b.TARGET.BUTTERFLYWING=!0))}if(1===k(0,50)&&0===b.TARGET.BUTTERFLY.length){a=k(100,
e.WIDTH-100);d=k(80,e.HEIGHT-80);var f=0<a-b.POS.BUTTERFLY[0]?b.POS.BUTTERFLY[0]:a,g=0<a-b.POS.BUTTERFLY[0]?a:b.POS.BUTTERFLY[0],l=0<d-b.POS.BUTTERFLY[1]?b.POS.BUTTERFLY[1]:d,z=0<d-b.POS.BUTTERFLY[1]?d:b.POS.BUTTERFLY[1];a=Array.apply(null,Array(5)).map(function(a){return[k(f,g),k(l,z)]});b.TARGET.BUTTERFLY=a}}function A(a){if(l.Walk===c.State){0<b.LIFEADDPOS.length&&(b.LIFEADDPOS[3]-=.5*a,b.LIFEADDPOS[1]-=.5,b.LIFEADDPOS[2]+=.1,.05>=b.LIFEADDPOS[3]&&(b.LIFEADDPOS=[]));var h=3*a;b.LIFE.APPLE=b.LIFE.APPLE.map(function(a){return a-
h});b.LIFE.CARROT=b.LIFE.CARROT.map(function(a){return a-h});b.LIFE.STRAWBERRY=b.LIFE.STRAWBERRY.map(function(a){return a-h});b.LIFE.APPLE=b.LIFE.APPLE.filter(function(a){return 0<a});b.LIFE.CARROT=b.LIFE.CARROT.filter(function(a){return 0<a});b.LIFE.STRAWBERRY=b.LIFE.STRAWBERRY.filter(function(a){return 0<a});b.POS.APPLE=b.LIFE.APPLE.map(function(a,d){var c=Math.floor(.02*(1E3-a)),e=b.POS.APPLE[d];return[e[0]>b.PATH.APPLE[d][c][0]?e[0]-.1*h:e[0]+.1*h,e[1]+.1*h,20+c]});b.POS.CARROT=b.LIFE.CARROT.map(function(a,
d){var c=Math.floor(.02*(1E3-a)),e=b.POS.CARROT[d];return[e[0]>b.PATH.CARROT[d][c][0]?e[0]-.1*h:e[0]+.1*h,e[1]+.1*h,20+c]});b.POS.STRAWBERRY=b.LIFE.STRAWBERRY.map(function(a,d){var c=Math.floor(.02*(1E3-a)),e=b.POS.STRAWBERRY[d];return[e[0]>b.PATH.STRAWBERRY[d][c][0]?e[0]-.1*h:e[0]+.1*h,e[1]+.1*h,20+c]});b.ITEMTIMER-=a;if(!(0<b.ITEMTIMER||(a=0+b.PATH.APPLE.length,a+=b.PATH.CARROT.length,a+=b.PATH.STRAWBERRY.length,0<a||(b.ITEMTIMER=10*n.init.timefps,0===Math.round(Math.random()))))){a={0:"APPLE",
1:"CARROT",2:"STRAWBERRY"}[k(0,2)+""];var f=k(200,600),g=Array.apply(null,Array(20)).map(function(a,b){var c=.2+.04*b;return[Math.pow(1-c,3)*d.Path.x+3*c*Math.pow(1-c,2)*d.PATHPOINT.P1TX+3*c*c*(1-c)*d.PATHPOINT.P1BX+c*c*c*f,Math.pow(1-c,3)*e.WIDTH+3*c*Math.pow(1-c,2)*d.PATHPOINT.P1TY+3*c*c*(1-c)*d.PATHPOINT.P1BY+c*c*c*e.HEIGHT]});b.PATH[a].push(g);b.LIFE[a].push(999);b.POS[a].push([g[0][0],g[0][1],20]);console.log(a,b.LIFE[a])}}}function B(){b.POS.APPLE.map(function(a){f.ctx.drawImage(b.PIC.APPLE,
a[0],a[1],a[2],a[2])});b.POS.CARROT.map(function(a){f.ctx.drawImage(b.PIC.CARROT,a[0],a[1],a[2],a[2])});b.POS.STRAWBERRY.map(function(a){f.ctx.drawImage(b.PIC.STRAWBERRY,a[0],a[1],a[2],a[2])});4===b.LIFEADDPOS.length&&(f.ctx.globalAlpha=b.LIFEADDPOS[3],f.ctx.drawImage(b.PIC.LIKE,b.LIFEADDPOS[0],b.LIFEADDPOS[1],b.LIFEADDPOS[2],b.LIFEADDPOS[2]),f.ctx.globalAlpha=1)}function C(a){if(c.State===l.Walk){var b=1*a;.5*e.WIDTH-1>d.Path.x&&(d.Pos=d.Pos.map(function(a){a[0]+=b;a[0]>e.WIDTH&&(a[0]-=e.WIDTH);
return a}),d.Path.x+=b,d.PathSet.x+=b);.5*e.WIDTH<d.Path.x&&(d.Pos.map(function(a){a[0]-=b;0>a[0]&&(a[0]+=e.WIDTH)}),d.Path.x-=b,d.PathSet.x-=b)}}function D(a){if(-1!==a&&a!=t&&c.State===l.Walk){var b=(new Date).getTime()-c.TimeSet.getTime();d.Pos[a][2]>.5*d.PicChangeSize&&""===d.PicLargekey&&(d.PicLargekey=d.PicKey[a],q(d.PicLargekey));d.Pos[a][2]=d.PicSize+b/1E4;0>d.Pos[a][1]-.33*d.Pos[a][2]&&(d.Pos[a][1]+=.7);d.Pos.map(function(a,b){a[2]>d.PicSize&&b<d.Pos.length-1&&(d.Pos[b][2]-=.7,d.Pos[b][2]<
d.PicSize&&(d.Pos[b][2]=d.PicSize))});if(d.Pos[a][2]>d.PicChangeSize){b=d.Pic.splice(a,1)[0];var e=d.Pos.splice(a,1)[0];d.PicKey.splice(a,1);d.PicOut=[b,e];c.Target=-1;q("")}}}function E(){d.Pos.map(function(a,b){b!==c.Target&&f.ctx.drawImage(d.Pic[b],a[0]-.5*a[2],a[1]-.33*a[2],a[2],.67*a[2])});if(-1!==c.Target){var a=c.Target,b=d.Pos[a];""!==d.PicLarge?f.ctx.drawImage(d.PicLarge,b[0]-.5*b[2],b[1]-.33*b[2],b[2],.67*b[2]):f.ctx.drawImage(d.Pic[a],b[0]-.5*b[2],b[1]-.33*b[2],b[2],.67*b[2])}}function q(a){""===
a?(d.PicLarge="",d.PicLargekey=""):r("imgdata/"+a+".json",function(a){console.log(a);d.PicLarge=new Image;d.PicLarge.src="data:image/png;base64,"+a.data})}function F(a){if(c.State===l.Walk){var b=1*a;.5*e.WIDTH-1>d.Path.x&&(g.POS.MOUNTAIN2[0]+=b,g.POS.CLOUD.map(function(a,c){g.POS.CLOUD[c][0]+=b}));.5*e.WIDTH<d.Path.x&&(g.POS.MOUNTAIN2[0]-=b,g.POS.CLOUD.map(function(a,c){g.POS.CLOUD[c][0]-=b}));g.POS.MOUNTAIN2[0]=g.POS.MOUNTAIN2[0]>e.WIDTH?g.POS.MOUNTAIN2[0]%e.WIDTH:g.POS.MOUNTAIN2[0];g.POS.MOUNTAIN2[0]=
0>g.POS.MOUNTAIN2[0]?g.POS.MOUNTAIN2[0]+e.WIDTH:g.POS.MOUNTAIN2[0];g.POS.CLOUD.map(function(a,c){g.POS.CLOUD[c][0]-=.02*b*g.POS.CLOUD[c][2]});g.POS.CLOUD=g.POS.CLOUD.filter(function(a){return 0<a[0]+a[2]});g.POS.CLOUD.length<g.CPT.CLOUD&&g.POS.CLOUD.push([e.WIDTH,k(20,150),k(30,50)])}}function G(){f.ctx.globalAlpha=1-m.NOWAIR[3];g.POS.CLOUD.map(function(a){f.ctx.drawImage(g.PIC.CLOUD,a[0],a[1],a[2],a[2])});f.ctx.globalAlpha=1;var a=g.POS.MOUNTAIN2;f.ctx.drawImage(g.PIC.MOUNTAIN2,a[0]-e.WIDTH,a[1],
e.WIDTH,e.MIDDLE);f.ctx.drawImage(g.PIC.MOUNTAIN2,a[0],a[1],e.WIDTH,e.MIDDLE)}function H(){f.ctx.globalAlpha=m.NOWAIR[3];g.POS.STAR.map(function(a){f.ctx.drawImage(g.PIC.STAR,a[0],a[1],a[2],a[2])});f.ctx.globalAlpha=1}function I(a){var e=0;a.map(function(f){r("data/"+f,function(h){"data.json"===f&&(h.pic.map(function(a,b){d.Pic.push(new Image);d.PicKey.push(a.slice(60,90).split("/").join(""));d.Pic[b].src="data:image/png;base64,"+a}),d.SetBgPic());"bgobj.json"===f&&(Object.entries(h).map(function(a){g.PIC[a[0]]=
new Image;g.PIC[a[0]].src="data:image/svg+xml;base64,"+a[1]}),g.SetBgObjPos());"itemobj.json"===f&&(Object.entries(h).map(function(a){b.PIC[a[0]]=new Image;b.PIC[a[0]].src="data:image/svg+xml;base64,"+a[1]}),b.SetPos());"snail.json"===f&&(Object.entries(h).map(function(a){c.PIC[a[0]]=new Image;c.PIC[a[0]].src="data:image/svg+xml;base64,"+a[1]}),c.SetPos());e++;e+1===a.length&&J()},function(a){console.error(a)})})}function J(){f.init();n.intervalId=setInterval(function(){f.update(1/n.init.fps);f.draw()},
1E3/n.init.fps)}n.init={VER:"1.0",canvasID:"main_canvas",timefps:60,fps:30};var f={obj:document.getElementById(n.init.canvasID)};f.obj.width=window.innerWidth;f.obj.height=window.innerHeight;var e={WIDTH:f.obj.width,HEIGHT:f.obj.height,MIDDLE:.5*f.obj.width,HORIZONS:.5*f.obj.height};f.init=function(){f.ctx=f.obj.getContext("2d");f.bound=f.obj.getBoundingClientRect();f.obj.addEventListener("click",u,!1)};f.update=function(a){g.AIRTIMER-=a;if(!(0<g.AIRTIMER)){g.AIRTIMER=n.init.timefps;var b=new Date;
var e=[b.getHours(),b.getMinutes()];b=m.AIR[e[0]];var f=m.AIR[e[0]%24];e=.167*e[1];m.NOWAIR=[b[0]+Math.floor((f[0]-b[0])*e),b[1]+Math.floor((f[1]-b[1])*e),b[2]+Math.floor((f[2]-b[2])*e),b[3]]}C(a);if(c.State!==l.Rest){b=20*a;f=d.Path.x||0;e=d.PathSet.x||0;var k=Math.abs(f-e);1<k?(c.State!==l.Turn&&(c.State=l.Turn),d.Path.x=b<k?f>e?f-b:f+b:f>e?f-k:f+k):c.State!==l.Walk&&(c.State=l.Walk,c.TimeSet=new Date)}F(a);D(c.Target);A(a);y(a);x(a)};f.draw=function(){var a=f.ctx.createLinearGradient(0,0,0,e.HORIZONS);
a.addColorStop(0,m.SKY.TOP);a.addColorStop(1,m.SKY.BOTTOM);f.ctx.fillStyle=a;f.ctx.fillRect(0,0,e.WIDTH,e.HORIZONS);a=f.ctx.createLinearGradient(0,e.HORIZONS,0,e.HEIGHT);a.addColorStop(0,m.LAND.TOP);a.addColorStop(1,m.LAND.BOTTOM);f.ctx.fillStyle=a;f.ctx.fillRect(0,e.HORIZONS,e.WIDTH,e.HEIGHT);a=f.ctx.createLinearGradient(0,e.HORIZONS,0,e.HEIGHT);a.addColorStop(0,m.PATH.TOP);a.addColorStop(1,m.PATH.BOTTOM);f.ctx.beginPath();f.ctx.strokeStyle=m.PATH.BOTTOM;f.ctx.moveTo(d.Path.x,e.HORIZONS);f.ctx.bezierCurveTo(d.PATHPOINT.P1TX,
d.PATHPOINT.P1TY,d.PATHPOINT.P1BX,d.PATHPOINT.P1BY,.5*e.WIDTH-.5*e.MIDDLE,e.HEIGHT);f.ctx.lineTo(.5*e.WIDTH+.5*e.MIDDLE,e.HEIGHT);f.ctx.bezierCurveTo(d.PATHPOINT.P2BX,d.PATHPOINT.P2BY,d.PATHPOINT.P2TX,d.PATHPOINT.P2TY,d.Path.x,e.HORIZONS);f.ctx.closePath();f.ctx.fillStyle=a;f.ctx.fill();G();f.ctx.globalAlpha=m.NOWAIR[3];f.ctx.fillStyle=p(m.NOWAIR.slice(0,3));f.ctx.fillRect(0,0,e.WIDTH,e.HEIGHT);f.ctx.globalAlpha=1;H();E();0!==d.PicOut.length&&(1>d.PicOut[1][1]+.67*d.PicOut[1][2]?d.PicOut=[]:(f.ctx.drawImage(d.PicOut[0],
d.PicOut[1][0]-.5*d.PicOut[1][2],d.PicOut[1][1]-.33*d.PicOut[1][2],d.PicOut[1][2],.67*d.PicOut[1][2]),--d.PicOut[1][1]));B();f.ctx.drawImage(b.PIC.BUTTERFLY,b.POS.BUTTERFLY[0]-.5*b.POS.BUTTERFLY[2],b.POS.BUTTERFLY[1],b.POS.BUTTERFLY[2],b.POS.BUTTERFLY[3]);a=c.Pos;var g=c.MovIdx;f.ctx.drawImage(c.PIC.HEAD,a[0]+12,a[1]-10+c.Mov[g][0]+c.PosYAdd[0],a[2]-12,a[2]-12);f.ctx.drawImage(c.PIC.TAIL,a[0]+14,a[1]+20+c.Mov[g][1]+c.PosYAdd[1],a[2]-16,a[2]-16);f.ctx.drawImage(c.PIC.BODY,a[0],a[1]+c.Mov[g][2]+c.PosYAdd[2],
a[2],a[2]);f.ctx.drawImage(b.PIC.LIKE,b.POS.LIKE[0],b.POS.LIKE[1],b.POS.LIKE[2],b.POS.LIKE[2]);f.ctx.fillStyle="#FD0";f.ctx.fillRect(e.WIDTH-140,13,104,8);f.ctx.fillStyle="#e44";f.ctx.fillRect(e.WIDTH-38-c.Energy,14,c.Energy,6)};var m={AIR:[[11,3,32,.7],[11,3,32,.7],[11,3,32,.7],[11,3,32,.6],[11,3,32,.5],[98,12,116,.4],[158,40,160,.3],[226,88,153,.2],[219,179,120,.1],[232,226,187,0],[232,226,187,0],[232,226,187,0],[232,226,187,0],[232,226,187,0],[232,226,187,0],[232,226,187,0],[239,217,172,.2],[242,
170,104,.3],[219,78,123,.4],[68,18,91,.5],[11,3,32,.6],[11,3,32,.7],[11,3,32,.7],[11,3,32,.7],[11,3,32,.7]],NOWAIR:[],SKY:{TOP:p([89,166,224]),BOTTOM:p([167,208,239])},PATH:{TOP:p([191,181,168]),BOTTOM:p([91,55,20])},LAND:{TOP:p([179,211,160]),BOTTOM:p([121,186,83])}},d={PATHPOINT:{P1TX:e.MIDDLE-.5*e.MIDDLE,P1TY:e.HORIZONS+.2*e.HORIZONS,P1BX:e.MIDDLE-.1*e.MIDDLE,P1BY:e.HORIZONS+.8*e.HORIZONS,P2TX:e.MIDDLE-.3*e.MIDDLE,P2TY:e.HORIZONS+.2*e.HORIZONS,P2BX:e.MIDDLE+.6*e.MIDDLE,P2BY:e.HORIZONS+.8*e.HORIZONS},
Path:{x:e.MIDDLE,y:e.HORIZONS},PathSet:{x:e.MIDDLE,y:e.HORIZONS},Pic:[],PicKey:[],PicLarge:"",Pos:[],PicSize:18,PicHarfSize:9,PicChangeSize:500,PicOut:[],SetBgPic:function(){d.Pos=Array.apply(null,Array(d.Pic.length)).map(function(a){return[k(0,e.WIDTH),k(e.HORIZONS-.3*e.HORIZONS,e.HORIZONS-.1*e.HORIZONS),d.PicSize]})}},g={OBJLIST:"MOUNTAIN2 CLOUD MOON STAR STONE_A STONE_B".split(" "),AIRTIMER:0,CPT:{},PIC:{},POS:{},SetBgObjPos:function(){g.POS.MOUNTAIN2=[.5*e.WIDTH,e.HORIZONS-.4*e.WIDTH];g.CPT.CLOUD=
10;g.POS.CLOUD=Array.apply(null,Array(g.CPT.CLOUD)).map(function(a){return[k(0,e.WIDTH),k(.1*e.HORIZONS,.35*e.HORIZONS),k(30,50)]});g.CPT.STAR=30;g.POS.STAR=Array.apply(null,Array(g.CPT.STAR)).map(function(a){return[k(0,e.WIDTH),k(0,.35*e.HORIZONS),k(2,5)]})}},b={ITEMTIMER:0,OBJLIST:["APPLE","CARROT","STRAWBERRY","LIKE","BUTTERFLY"],PATH:{},LIFE:{},LIFEADDPOS:[],POS:{},TARGET:{},PIC:{},SetPos:function(){b.PATH.APPLE=[];b.PATH.CARROT=[];b.PATH.STRAWBERRY=[];b.LIFE.APPLE=[];b.LIFE.CARROT=[];b.LIFE.STRAWBERRY=
[];b.POS.APPLE=[];b.POS.CARROT=[];b.POS.STRAWBERRY=[];b.POS.LIKE=[e.WIDTH-30,10,16];b.POS.BUTTERFLY=[.5*e.WIDTH,.5*e.HORIZONS,20,20];b.TARGET.BUTTERFLY=[];b.TARGET.BUTTERFLYWING=!0;b.TARGET.BUTTERFLYSPEED=30}},l={Walk:1,Rest:2,Turn:3},c={PIC:{},Pos:[e.MIDDLE-20,e.HEIGHT-80,50],MovIdx:0,Target:-1,TimeSet:new Date,State:l.Walk,EnergyMax:100,Energy:100,SetPos:function(){c.RestPostYOri=[20,-12,2];c.PosYAdd=[0,0,0];c.Mov=[[0,0,0],[.05,-.05,.02],[.25,-.25,.03],[.5,-.5,.07],[1,-1,.12],[1.7,-1.7,.17],[2,
-2,.22],[2,-2,.3],[1.9,-1.9,.35],[1.8,-1.8,.4],[1.7,-1.7,.5],[1.6,-1.6,.65],[1.5,-1.5,.75],[1.4,-1.4,1],[1.3,-1.3,.92],[1.2,-1.2,.95],[1.1,-1.1,.92],[1,-1,.85],[.9,-.9,.7],[.8,-.8,.67],[.7,-.7,.5],[.6,-.6,.37],[.5,-.5,.32],[.5,-.5,.27],[.4,-.4,.2],[.3,-.3,.15],[.25,-.25,.1],[.15,-.15,.07],[.1,-.1,.05],[.05,-.05,.02]]}};n.main=function(){I(["bgobj.json","itemobj.json","data.json","snail.json"])};return n}(window.SipuViewer||{});SipuViewer.main();